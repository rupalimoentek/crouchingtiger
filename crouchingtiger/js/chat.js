/**
 * MiniEE is a client and server side library for routing events.
 * Main difference from EventEmitter is that callbacks can be specified using RegExps.
 *
 * Should work on the client and the server.
 */
var MiniEventEmitter=function(){};MiniEventEmitter.prototype.each=function(e,t,n){var r={};if(e==null)return;if(Array.prototype.forEach&&e.forEach===Array.prototype.forEach)e.forEach(t,n);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(n,e[i],i,e)===r)return}else for(var o in e)if(e.hasOwnProperty(o)&&t.call(n,e[o],o,e)===r)return},MiniEventEmitter.prototype.filter=function(e,t,n){var r=[];return e==null?r:Array.prototype.filter&&e.filter===Array.prototype.filter?e.filter(t,n):(MiniEventEmitter.prototype.each(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},MiniEventEmitter.prototype.on=function(e,t){return e instanceof RegExp?(this._routes||(this._routes=[]),this._routes.unshift([e,t])):(this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].unshift(t)),this},MiniEventEmitter.prototype.addListener=MiniEventEmitter.prototype.on,MiniEventEmitter.prototype.once=function(e,t){function r(){n.removeListener(e,r),t.apply(this,arguments)}var n=this;return r.listener=t,n.on(e,r),this},MiniEventEmitter.prototype.when=function(e,t){function r(){t.apply(this,arguments)&&n.removeListener(e,r)}var n=this;return r.listener=t,n.on(e,r),this},MiniEventEmitter.prototype.removeListener=function(e,t){return e instanceof RegExp&&this._routes?this._routes=MiniEventEmitter.prototype.filter(this._routes,function(n){return n[0].toString()!=e.toString()||!(n[1]===t||n[1].listener&&n[1].listener===t)}):this._events&&this._events[e]&&(this._events[e]=MiniEventEmitter.prototype.filter(this._events[e],function(e){return!(e===t||e.listener&&e.listener===t)})),this},MiniEventEmitter.prototype.removeAllListeners=function(e){if(arguments.length===0){this._events={},this._routes=[];return}return e instanceof RegExp&&this._routes?this._routes=MiniEventEmitter.prototype.filter(this._routes,function(t){return t[0].toString()!=e.toString()}):this._events&&this._events[e]&&(this._events[e]=[]),this},MiniEventEmitter.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments,1);if(this._events&&this._events[e])for(var n=this._events[e].length-1;n>-1&&this._events[e]&&this._events[e][n];n--)this._events[e][n].apply(this,t);if(this._routes)for(var n=this._routes.length-1;n>-1;n--)this._routes[n][0].test(e)&&this._routes[n][1].apply(this,t);return this},MiniEventEmitter.mixin=function(e){var t=["on","removeListener","removeAllListeners","emit","next","once","when"];for(var n=0;n<t.length;n++)e.prototype[t[n]]=MiniEventEmitter.prototype[t[n]]},typeof module!="undefined"&&(module.exports=MiniEventEmitter);var chatLotus=function(e,t){function c(e){return i[e]}function h(e,t){var n,r=o.path.join(o.path.dirname(e.id),t).replace(/\.js$/,""),i=o.path.join(r,"index"),s=e.pkg,u=s.modules.length,a;while(u-->0){a=s.modules[u].id;if(a==r||a==i){n=s.modules[u];break}}return n}function p(e){return function(n){var r,i;if(/^\./.test(n))r=h(e,n);else{if(f&&f.hasOwnProperty(n))return f[n];i=c(n);if(!i&&u){try{i=u(n)}catch(s){}if(i)return i}if(!i)throw new Error('Cannot find module "'+n+'" @[module: '+e.id+" package: "+e.pkg.name+"]");r=i.index}if(!r)throw new Error('Cannot find module "'+n+'" @[module: '+e.id+" package: "+e.pkg.name+"]");return r.parent=e,r.call()}}function d(e,t){var n=r[e],i=t(n),o=!1;i.exports={},i.require=p(i),i.call=function(){return o?i.exports:(o=!0,s.require=i.require,i.wrapper(i,i.exports,s,a||s.Buffer,s.require),i.exports)},n.mainModuleId==i.id&&(n.index=i,n.parents.length===0&&(l.main=i.call)),n.modules.push(i)}function v(){var e=arguments[arguments.length-1],t=Array.prototype.slice.call(arguments,0,arguments.length-1),n=e(t);if(r.hasOwnProperty(n.id))throw new Error("Package#"+n.id+' "'+n.name+'" has duplication of itself.');r[n.id]=n,i[n.name]=n,arguments.length==1&&(i.main=n)}function m(e){return i.main.index.require(e)}function g(){return o.process.stderr.content}function y(){return o.process.stdin.content}function b(){return o.process.stdout.content}var n=!1,r={},i={},s={},o,u=typeof require!="undefined"&&require,a=typeof Buffer!="undefined"&&Buffer,f,l;return f={player:window.Player,underscore:window._,pubsub:window.Pubsub,minilog:window.Minilog,lotus:window.Lotus,zendesk:window.Zendesk,jquery:window.jQuery,ember:window.Em,radar:window.RadarClient,radar_client:window.RadarClient},o=function(e){return e.path=function(e){return e.join=function(){return e.normalize(Array.prototype.join.call(arguments,"/"))},e.normalizeArray=function(e,n){var r=[],i;for(var s=0,o=e.length-1;s<=o;s++){var u=e[s];if(u===""&&s!==0&&s!==o&&!n)continue;if(u==="."&&i!==t)continue;u===".."&&r.length&&i!==".."&&i!=="."&&i!==t&&(i!==""||n)?(r.pop(),i=r.slice(-1)[0]):(i==="."&&r.pop(),r.push(u),i=u)}return r},e.normalize=function(t,n){return e.normalizeArray(t.split("/"),n).join("/")},e.dirname=function(e){return e&&e.substr(0,e.lastIndexOf("/"))||"."},e}({}),e}({}),l={lib:o,findPkg:c,findModule:h,name:"chatLotus",module:d,pkg:v,packages:i,stderr:g,stdin:y,stdout:b,require:m}}(this);chatLotus.pkg(function(e){return{id:1,name:"chat_lotus",main:undefined,mainModuleId:"index",modules:[],parents:e}}),chatLotus.module(1,function(){return{id:"casperjs-patch",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){if(!/casperjs/i.test(navigator.userAgent))return;var o=window.XMLHttpRequest.prototype.send;window.XMLHttpRequest.prototype.send=function(){var e=this,t=arguments;setTimeout(function(){o.apply(e,t)},0)}}}}),chatLotus.module(1,function(){return{id:"chat/accessors",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o,u,a=i("ember");(function(){var e={some:{key:"value"}},t=a.get(e,"some.key")==="value";o=t?a.get:a.getPath,u=t?a.set:a.setPath})(),e.exports={get:o,set:u}}}}),chatLotus.module(1,function(){return{id:"chat/agent/controllers/invites_controller",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function d(e){e.op==="client_offline"&&v(e.value.userId)}function v(e){var t=p.get("content"),n=t.length;while(n-->0)t[n].get("userId")==e&&(a.info({event:"chat-is-expired",userId:e}),p.remove(t[n].get("chatId")))}var o=i("ember").ArrayProxy,u=i("../models/invite"),a=i("minilog")("chat_invites"),f=i("../../shared"),l=i("../../common/controllers/chats_controller"),c=i("radar_client"),h=i("../../accessors").get;c.alloc("chat",function(){c.presence("chat/availability",{version:2}).on(d)});var p=e.exports=o.extend({content:[],chatsController:l,accept:function(e){a.info({event:"accepting-invite",chatId:e.id}),e.accept()},ignore:function(e){a.info({event:"ignoring-invite",chatId:e.id}),this.remove(e.chatId),e.ignore()},isAvailable:function(){var e=h(this,"chatsController.content").filter(function(e){return!e.get("ended")&&!e.get("endedByChat")}).length,t=f.Agent.maximum_chat_requests,n=t>e;return a.info({event:"check-quota",activeChats:e,quota:t,available:n}),!n&&a.info({event:"agent-reached-invitation-quota"}),n}.property("chatsController.length","chatsController.@each.ended").cacheable(),remove:function(e){var t=this.findProperty("chatId",e);return this.removeObject(t),t},createInvite:function(e){var t=u.create(e),n=c.presence("chat/"+e.chatId+"/participants");n.on(function(e){e.op==="client_offline"&&(v(e.value.userId),n.unsubscribe())}).subscribe(),this.pushObject(t)},add:function(e){var t=$.Deferred(),n=this;if(e&&e.params&&e.params.ticket_id){var r=parseInt(e.params.ticket_id,10);$.ajax({type:"GET",url:"/api/v2/tickets/%@".fmt(r),dataType:"json"}).done(function(t){parseInt(e.userId,10)==parseInt(t.ticket.requester_id,10)?e.ticketId=r:delete e.params.ticket_id,n.createInvite(e)}).error(function(t){delete e.params.ticket_id,n.createInvite(e)}).always(function(){t.resolve()})}else this.createInvite(e),t.resolve();return t.promise()},hasInvites:function(){return this.get("length")>0&&this.get("isAvailable")}.property("length","isAvailable"),hasNoInvites:function(){return!this.get("hasInvites")}.property("hasInvites")}).create()}}}),chatLotus.module(1,function(){return{id:"chat/agent/models/conversation",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("../../common/models/conversation"),u=i("../../common/models/elapsed_time"),a=i("../transcription"),f=i("minilog")("chat_agent_conversation"),l=i("../../shared"),c=i("zendesk");e.exports=o.extend({totalChatTime:null,userWaitTime:null,init:function(){this._super(),this.totalChatTime=new u,this.totalChatTime.start(),this.userWaitTime=new u},listen:function(){var e=this;this._super(),this.on("message",function(t){t.type=="message"&&t.user_id&&(parseInt(t.user_id,10)==parseInt(l.service.userId,10)?e.userWaitTime.stop():e.userWaitTime.start())}),this.once("end",function(){a.save(e,function(e,t,n){n.set("isSaving",!1);if(e){n.set("hasErrors",!0);return}if(!c||!c.Comment)return;var r=t.get("chatController");r&&r.routeEndedChat()}),f.info({event:"chat-end",endedBy:e.get("endedByAgent"),duration:e.totalChatTime.get("duration")}),e.totalChatTime.stop(),e.userWaitTime.stop()})}})}}}),chatLotus.module(1,function(){return{id:"chat/agent/models/invite",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("../../common/models/elapsed_time"),a=i("../../shared"),f=e.exports=o.Object.extend({id:null,chatId:null,userId:null,ticketId:null,subject:null,_user:null,init:function(){this.id=this.get("id"),this.userId=this.get("userId"),this.chatId=this.get("chatId"),this.ticketId=this.get("ticketId"),this.ticketLink=o.I18n.t("txt.ticket.id_label",{id:this.get("ticketId")}),this.ticketHref="/tickets/"+this.get("ticketId"),this.waitTime=new u,this.waitTime.start();var e=i("../../common/models/user"),t=e.create({id:this.get("userId")}),n=this;t.fetch().done(function(e){var r=t.get("organization");if(r)r.fetch(),n.set("organization",r);else{var i=t.get("organization_id");if(!i)return;$.get("/api/v2/organizations/"+i+".json",{},function(e){n.set("organizationHref","/organizations/"+i),n.set("organization",e.organization.name)})}}),this._user=t},truncatedSubject:function(){var e=this.get("subject")||"",t=e.substring(0,80);return e.length>80&&(t+="..."),t}.property("subject"),hasTicket:function(){return this.get("ticketId")!=null}.property(),accept:function(){a.service.acceptAgent(this.chatId,this.id),this.waitTime.stop()},ignore:function(){this.waitTime.stop()},user:function(){return this._user}.property()})}}}),chatLotus.module(1,function(){return{id:"chat/agent/transcription",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("zendesk"),a=i("minilog")("chat_transcript"),f=i("../accessors").get,l={save:function(e,t){var n=e.get("ticket"),r={value:l._transcript(e.get("messages")),is_public:!0};a.info({op:"save-transcript",room:e.get("room"),ticketId:n.get("id")});try{u&&u.Comment?(r=u.Comment.create({type:"Comment",is_public:!0}),r.set("body",l._transcript(e.get("messages"))),n.get("isNew")&&(n=f(e,"workspace.ticket"),n.set("subject",e.get("subject")))):n.get("id")||(n.set("subject",e.get("subject")),n.set("assignee_id",window.ChatService.userId),n.set("status_id",u.Ticket.Statuses.OPEN),n.set("priority_id",u.Ticket.Priorities.NORMAL),n.set("ticket_type_id",u.Ticket.Types.QUESTION)),n.set("comment",r),n.set("requester",e.get("requester")),n.set("via_id",u.Ticket.Vias.CHAT),n.set("via",{channel:"chat"}),n.set("isSaving",!0)}catch(c){a.info({op:"save-transcript-exception",room:e.get("room"),reason:c.toString(),stack:c.stack,exception:c});var h=i("lib/growl");h&&h.error&&h.error(o.I18n.t("txt.chat.notices.ticket_save_unknown_error")),t("error",e,n);return}var p=n.save({update:!1});p?p.done(function(r,i,o){if(!n.get("id")){var u=o.getResponseHeader("Location"),f=u.match(/tickets\/([0-9]+)\.json/)[1];n.set("id",f)}e.set("ticketId",n.get("id")),a.info({op:"save-transcript-success",room:e.get("room"),ticketId:n.get("id")}),t(s,e,n)}).fail(function(r,i,s){var o=JSON.parse(r.responseText);a.info({op:"save-transcript-failure",room:e.get("room"),reason:o}),t(i,e,n)}):t("unknown error",e,n)},_transcript:function(e){var t=[];return e.forEach(function(e){var n="",r=f(e,"user.alias")||f(e,"user.name");e.get("message")?n+=r+" "+e.get("hour")+":"+e.get("minute")+":"+"\n"+e.get("message"):e.get("notification")&&(n+=o.I18n.t("txt.chat.user_"+(e.get("userJoined")?"joined":"left"),{user:r})),t.push(n)}),o.$.trim(t.join("\n\n"))}};e.exports=l}}}),chatLotus.module(1,function(){return{id:"chat/common/activity_sender",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function p(){var e=u(window.Chat,"chatsController.current");if(!e)return;e.activity(c.state)}function y(){function e(){v=null,!m&&!g&&b(o.GONE)}clearTimeout(v),v=setTimeout(e,f)}function b(e){var t=h[c.state];t.indexOf(e)>-1&&(c.state=e,p()),clearTimeout(v)}function w(){function e(){d=null,!m&&!g&&b(o.INACTIVE)}clearTimeout(d),d=setTimeout(e,1e3)}function E(){function e(){m=null,w()}var t=!m;clearTimeout(m),m=setTimeout(e,1e3),t&&b(o.COMPOSING)}function S(){function e(){g=null,w()}var t=!g;clearTimeout(g),g=setTimeout(e,1e3),t&&b(o.ACTIVE)}var o=i("./activity_states"),u=i("../accessors").get,a=1e3,f=6e5,l={},c=l;c.state=o.ACTIVE;var h={};h[o.INACTIVE]=[o.ACTIVE,o.COMPOSING,o.GONE],h[o.ACTIVE]=[o.COMPOSING,o.INACTIVE,o.GONE],h[o.COMPOSING]=[o.INACTIVE,o.GONE],h[o.GONE]=[o.INACTIVE,o.ACTIVE,o.COMPOSING,o.GONE];var d,v,m,g;c.notifySend=c.notifyDelete=function(){S(),y()},c.notifyTyping=function(){E(),y()},e.exports=c}}}),chatLotus.module(1,function(){return{id:"chat/common/activity_states",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=["ACTIVE","COMPOSING","PAUSED","INACTIVE","GONE"],u=-1;while(++u<o.length)e.exports[o[u]]=u+1;e.exports.getKey=function(t){return o[t-1]}}}}),chatLotus.module(1,function(){return{id:"chat/common/audio",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("player").Audio,u=i("ember"),a="/media/audio";e.exports=u.Object.extend({name:null,basePath:a,format:"mp3",play:function(){this.get("sound").ready(function(e){e.play()})},sound:function(){return new o({domId:this.name,url:this.get("file"),swfUrl:"/media/voice/soundmanager"})}.property("name","file").cacheable(),file:function(){return this.basePath+"/"+this.name+"."+this.format}.property()}),e.exports.invite=e.exports.create({name:"invite"}),e.exports.message=e.exports.create({name:"message"})}}}),chatLotus.module(1,function(){return{id:"chat/common/controllers/chats_controller",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=o.ArrayProxy,a=i("../../shared"),f=i("../activity_sender"),l=i("../../accessors").get,c=i("../../accessors").set,h=e.exports=o.ArrayProxy.extend({_current:s,content:[],current:o.computed(function(e,t){return arguments.length==1?this.get("_current"):(this.set("_current",t),t&&(t.set("unread",!1),t.set("unreadMessages",0)),t)}),add:function(e){var t=i("../../agent/models/conversation"),n=i("../../agent/controllers/invites_controller");a.isAgent||(t=i("../models/conversation"));var r=n.findProperty("chatId",e),s=t.create({name:e,ticketId:r&&r.ticketId});return s.join(),a.isAgent&&$.ajax({dataType:"json",url:"/api/v2/channels/chat/users/%@/welcome_message".fmt(r.userId),async:!1}).done(function(e){s.send(e.welcome_message)}).fail(function(){s.send(a.Agent.chat_welcome_message)}),s.set("unread",!1),s.set("unreadMessages",0),this.pushObject(s),s},send:function(e){if(!e||!l(e,"draft.message"))return;var t=l(e,"draft.message").replace(/^\s+/mg,"").replace(/\s+/mg," ");t&&t.length&&(e.send(t),e.draft.set("message",""),window.Chat.activitySender.notifySend())},remove:function(e){this.removeObject(e),this.setCurrent(this.content[this.content.length-1])},active:function(){return this.filterProperty("active",!0)}.property("@each.active").cacheable(),setCurrent:function(e){c(window.Chat,"chatsController.current",e),e&&e.set("unread",!1),typeof navigate!="undefined"&&navigate.room(e&&e.name||s)}}).create()}}}),chatLotus.module(1,function(){return{id:"chat/common/models/conversation",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("zendesk"),a=i("minilog")("chat_conversation"),f=i("../../nexus").Room,l=i("./message"),c=i("./messages"),h=i("./participants"),p=i("../activity_states"),d,v=i("../../shared"),m=i("./user"),g=e.exports=o.Object.extend(f.prototype,{name:null,messages:null,participants:null,ended:null,unread:null,draft:null,started:!0,ticketId:null,init:function(){this._super(),this.participants=h.create({log:a}),this.messages=c.create({participants:this.participants}),this.draft=l.create(),this.activityReceiver={},this.setup(this.get("name"),v.service),this.listen()},listen:function(){var e=this;this.on("message",function(t){var n=t.type,r;if(n==="message"){r=e.messages.add(t),t.user_id!=v.service.userId?e.delivery(t.id):o.run.later(function(){r.get("verified")||r.set("delivered",!1)},5e3);var s;!d&&(d=i("../controllers/chats_controller")),d.get("current")!=this&&(s=this.get("unreadMessages"),this.set("unread",!0),this.set("unreadMessages",typeof s=="number"?s+1:1))}n==="user_info"&&(e.participants.add(t.users),e.messages.flushMessageQueue()),n==="delivery"&&t.user_id!=v.service.userId&&e.markAsDelivered(t.message);if(n==="activity"){e.activityReceiver.recentState={key:p.getKey(t.state),value:t.state,userId:t.user_id},e.emit("activity",e.activityReceiver.recentState);var u=e.participants.getById(t.user_id);u&&u.set("state",e.activityReceiver.recentState)}if(n==="origin"){if(t.name=="ticket"){var a=parseInt(t.meta.ticket_id,10);$.ajax({type:"GET",url:"/api/v2/tickets/%@".fmt(a),dataType:"json"}).done(function(n){parseInt(t.userId,10)==parseInt(n.ticket.requester_id,10)&&e.set("ticketId",t.meta.ticket_id)})}t.name=="feedback_tab"&&this.set("subject",t.meta.subject)}}),this.on("online",function(t){t!=v.service.userId&&e.messages.add({user_id:t,user_joined:!0,notification:"has joined the room"})}),this.on("offline",function(t){t!=v.service.userId&&(e.participants.exists(t)&&(a.info({event:"remove-participant",userId:t}),e.messages.add({user_id:t,user_left:!0,notification:"has left the room"}),e.participants.remove(t)),a.info({op:"end-chat-because-user-offline",userId:t}),e.end())})},publishUserInfo:function(e,t){var n=this,r=m.create({id:t});r.fetch().done(function(){var i={};i[n.service.userId]=e.get("alias")||e.get("name"),i[t]=r.get("alias")||r.get("name"),n.channel.publish({type:"user_info",users:i})})},markAsDelivered:function(e){var t=this.get("messages").get("content"),n=t.length;while(n--)if(t[n].get("id")==e){t[n].set("delivered",!0),t[n].set("verified",!0);break}},end:function(){this.set("ended",!0),this.leave(),this.emit("end"),a.info({event:"end-chat"})},active:function(){return this.get("started")&&!this.get("ended")}.property("started","ended"),ticket:function(){return u.Ticket.create({id:this.ticketId})}.property("ticketId").cacheable(),didSaveTranscription:o.K})}}}),chatLotus.module(1,function(){return{id:"chat/common/models/elapsed_time",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=5,a=e.exports=o.Object.extend({duration:s,beginTime:s,timer:s,isCounting:function(){return this.timer!==s},reset:function(){this.timer=s,this.beginTime=s,this.update()},start:function(){var e=this;this.isCounting()||(this.beginTime=+(new Date),this.timer=setInterval(function(){e.update.call(e)},1e3/u),this.update())},stop:function(){this.isCounting()&&(clearInterval(this.timer),this.reset())},update:function(){this.set("duration",this.beginTime===s?s:Math.floor((+(new Date)-this.beginTime)/1e3))}})}}}),chatLotus.module(1,function(){return{id:"chat/common/models/message",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("./user"),a=i("../../shared"),f=o.Object.extend({id:null,delivered:!0,verified:!1,userId:null,message:null,notification:null,at:function(){return new Date}.property().cacheable(),hour:function(){var e=this.get("at"),t=this.get("user");return t.get("uses_12_hour_clock")?this._getAMPMHour(e):e.getHours()}.property("at","message.user.uses_12_hour_clock"),minute:function(){var e=this.get("at").getMinutes();return e<10?"0"+e:e}.property("at"),_getAMPMHour:function(e){var t=e.getHours();return t>12?t-12:t}});e.exports=f}}}),chatLotus.module(1,function(){return{id:"chat/common/models/messages",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("./message"),a=i("../../shared"),f=i("./participants"),l=e.exports=o.ArrayProxy.extend({content:null,init:function(){var e;this._super(),this.set("content",[]),this.set("messageQueue",[]),e=this.get("participants")||f.create({}),this.set("participants",e)},add:function(e){var t=e.user_id,n,r;return n=u.create({id:e.id||null,message:e.message||null,userId:t,user:this.participants.getById(t),notification:e.notification||null,userJoined:e.user_joined,userLeft:e.user_left}),n.get("user")?(this.pushObject(n),this.flushMessageQueue()):this.get("messageQueue").pushObject(n),n},flushMessageQueue:function(){var e=this,t=this.participants,n={};this.get("messageQueue").forEach(function(n){var r=t.getById(n.userId);n.set("user",r),e.pushObject(n)}),this.set("messageQueue",[])},isEmpty:function(){return this.content.length===0}.property("content.length"),isAny:function(){return!this.get("isEmpty")}.property("content.length")})}}}),chatLotus.module(1,function(){return{id:"chat/common/models/participants",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("./user"),a=i("./../../shared"),f=e.exports=o.ArrayProxy.extend({content:null,init:function(){this._super(),this.set("content",[]),this._idCache={}},add:function(e){var t;for(var n in e)this.exists(n)||(t=u.create({id:n,name:e[n],isFetchable:!1,isSavable:!1}),a.service.userId==n?this.set(a.isAgent?"agent":"enduser",t):this.set(a.isAgent?"enduser":"agent",t),this.pushObject(t),this._idCache[n]=t,this.log&&this.log.info({event:"add-participant",userId:n}))},agent:null,enduser:null,getById:function(e){return e+="",this._idCache[e]},getByType:function(){return this.filterProperty("type",2)},exists:function(e){return e+="",!!this._idCache[e]},remove:function(e){var t,n,r,i=this.get("content");for(t=i.length-1;t>0;t--)n=i[t],r=n.get("id"),r==e&&(this.removeAt(t),this._idCache[r]=null)}})}}}),chatLotus.module(1,function(){return{id:"chat/common/models/user",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("zendesk"),a=i("../../shared"),f=e.exports=u.User.extend({online:null,role:null,activity:null,available:null,url:"/api/v2/users",init:function(){this._super(),this.listen()},listen:function(){var e=this;a.service.status.on("online",function(t){e.isMe(t)&&e.set("available",!0)}),a.service.status.on("offline",function(t){e.isMe(t)&&e.set("available",!1)})},isMe:function(e){return this.get("id")==e}})}}}),chatLotus.module(1,function(){return{id:"chat/common/observer",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember");e.exports=o.Object.extend({itemWasAdded:function(e){},arrayWillChange:function(e,t,n,r){},arrayDidChange:function(e,t,n,r){r&&this.itemWasAdded(e.objectAt(t))}})}}}),chatLotus.module(1,function(){return{id:"chat/config",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function o(){return process&&process.env&&process.env.hasOwnproperty("DEBUG")}function f(){return u()+"/node"}var u=function(){var e="/";return function(t){return arguments.length&&(e=t),e}}(),a=function(){var e="/api/v2beta";return function(t){return arguments.length&&(e=t),e}}();e.exports={debug:o,workingURL:u,apiURL:a,nodeURL:f}}}}),chatLotus.module(1,function(){return{id:"chat/index",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function h(e,t,n){var r=i("./nexus"),o=i("./shared"),f=i("jquery"),l=i("./common/audio"),h=i("./common/observer"),p=h.create({itemWasAdded:function(){c.invitesController.get("hasInvites")&&l.invite.play()}}),d=h.create({itemWasAdded:function(){l.message.play()}}),v=h.create({itemWasAdded:function(e){e.get("messages").addArrayObserver(d)}});o.isAgent=n,o.service=u=new r.Service(t),o.accountName=t._me.accountName,n&&setTimeout(function(){f.getJSON(a.apiURL()+"/settings",function(e){o.Agent.maximum_chat_requests=e.maximum_chat_requests,o.Agent.chat_welcome_message=e.chat_welcome_message})},0),e.Chat.set("chatsController",c.chatsController),e.Chat.set("invitesController",c.invitesController),e.Chat.set("activitySender",i("./common/activity_sender")),e.Chat.invitesController.addArrayObserver(p),e.Chat.chatsController.addArrayObserver(v),e.Chat.set("hasConnection",navigator.onLine!==s?navigator.onLine:!0),f(window).bind("offline",function(){window.Chat.set("hasConnection",!1)}),f(window).bind("online",function(){window.Chat.set("hasConnection",!0)});var m;t.on("ready",function(){clearTimeout(m),m=null,window.Chat.set("hasConnection",!0)});var g=function(){if(m)return;m=setTimeout(function(){window.Chat.set("hasConnection",!1)},2e3)};t.on("disconnected",g),t.on("unavailable",g)}var o,u,a=i("./config"),f=i("ember"),l=i("./accessors").get,c=e.exports={invitesController:i("./agent/controllers/invites_controller"),chatsController:i("./common/controllers/chats_controller"),Common:{Observer:i("./common/observer"),Model:{User:i("./common/models/user")}},Agent:{Model:{Conversation:i("./agent/models/conversation")}},globals:null,initialize:h,getService:function(){return u}};f.Handlebars.registerHelper("renderMessage",function(e){var t=f.Handlebars.Utils.escapeExpression($.trim(l(this,e))).replace(/(^|\s)(www\.[^\s]+)/g,'$1<a href="http://$2" target="_blank">$2</a>').replace(/(^|\s)(http[^\s]+)/g,'$1<a href="$2" target="_blank">$2</a>');return new f.Handlebars.SafeString(t)})}}}),chatLotus.module(1,function(){return{id:"chat/nexus/index",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){e.exports.Room=i("./room"),e.exports.Service=i("./service")}}}),chatLotus.module(1,function(){return{id:"chat/nexus/new-id",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function o(){return Math.floor(Math.random()*99999999)}e.exports=o}}}),chatLotus.module(1,function(){return{id:"chat/nexus/room",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function f(e,t){this.setup(e,t)}var o=i("miniee"),u=i("minilog")("chat_nexus_room"),a=i("./new-id");f.prototype={setup:function(e,t){var n=this;this.room=e,this.service=t,this.radar=t.radar,this.presence=t.radar.presence("chat/"+this.room+"/participants"),this.channel=t.radar.message("chat/"+this.room+"/messages")},send:function(e){this.channel.publish({id:a(),type:"message",message:e,user_id:this.service.userId,at:(new Date).getTime()})},activity:function(e){this.channel.publish({type:"activity",user_id:this.service.userId,state:e})},delivery:function(e){this.channel.publish({type:"delivery",user_id:this.service.userId,message:e})},origin:function(e,t){this.channel.publish({type:"origin",user_id:this.service.userId,name:e,meta:t})},invite:function(e){this.radar.message("chat/user/"+e).publish({type:"invite",room:this.room,user_id:this.service.userId})},join:function(){this.observe(this.room),this.presence.set("online")},observe:function(e){var t=this;this.presence.on(function(e){if(!e.op||!e.value)return;if(e.op==="online"||e.op==="offline")for(var n in e.value)e.value.hasOwnProperty(n)&&t.emit(e.op,n);else e.op==="client_offline"&&(u.info({event:"converting-client-offline",userId:e.value.userId}),t.emit("offline",e.value.userId))}).sync(),this.channel.on(function(e){!e.type&&e.value&&e.value.type&&(e=e.value),t.emit("message",e)}).sync()},leave:function(){u.info({event:"leave-chat",id:this.room}),this.presence.set("offline").unsubscribe(),this.channel.unsubscribe()}},o.mixin(f),e.exports=f}}}),chatLotus.module(1,function(){return{id:"chat/nexus/service",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function a(e){var t=this;this.accountName=e._me.accountName,this.userId=e._me.userId,this.userType=e._me.userType,this.sessionId=Math.floor(Math.random()*1e5),this.presenceChannel="chat/availability",this.chatmanChannel="chat/manager",this.userChannel=function(){return"chat/user/"+t.userId},this.sessionChannel=function(){return"chat/manager/session/"+this.sessionId},this.radar=e,this.status={available:function(){e.presence(t.presenceChannel).set("online")},unavailable:function(){e.presence(t.presenceChannel).set("offline")}};var n=["on","removeListener","removeAllListeners","emit","next","once","when"];for(var r=0;r<n.length;r++)this.status[n[r]]=o.prototype[n[r]];e.once("ready",function(){u.info({event:"service-connected"}),t.userType>0&&e.message(t.userChannel()).on(function(e){u.info({event:"user-channel-message",message:e}),!e.type&&e.value&&e.value.type&&(e=e.value),t.emit(e.type,e)}).subscribe(),e.presence(t.presenceChannel).on(function(e){if(!e.op||!e.value)return;for(var n in e.value){if(!e.value.hasOwnProperty(n))continue;if(e.op=="online"||e.op=="offline")u.debug("emit status",e.op,n),t.status.emit(e.op,n)}}).sync(),t.emit("connect")}),u.debug("New service client has been created successfully.")}var o=i("miniee"),u=i("minilog")("chat_nexus_service");a.prototype.setSessionId=function(e){this.sessionId=e},a.prototype._listen=function(e){var t=this,n=function(e){u.info({event:"session-channel-message",message:e}),!e.type&&e.value&&e.value.type&&(e=e.value);if(e.type=="chat_id")return t.emit("debug_chat_id",e);t.emit(e.type,e)};u.info({event:"listen-to-session-channel"}),this.radar.message(t.sessionChannel()).on(n).subscribe(e)},a.prototype._createChat=function(e){u.info({event:"requesting-chat-id"});var t={type:"createChat",resource:"chat",action:"create",account:this.accountName,user_id:this.userId};this.radar.message(this.sessionChannel()).publish(t,e)},a.prototype.connect=function(){u.debug("Connection attempt has been delivered to the publisher facility."),this.radar.alloc("chat",function(){u.info({event:"chat-client-alloced"})})},a.prototype.getChat=function(){this._listen(function(){u.info({event:"listening-to-session-channel"})}),this._createChat(function(){u.info({event:"sent-create-chat-message"})})},a.prototype.fetchAgent=function(e,t,n){var r={type:"fetchAgent",resource:"agent",action:"fetch",chat:e,user_id:this.userId,subject:t,params:n};this.radar.message(this.sessionChannel()).publish(r)},a.prototype.acceptAgent=function(e,t){var n={type:"acceptAgent",resource:"agent",action:"accept",chat:e,response_to:t,account:this.accountName,user_id:this.userId};this.radar.message(this.chatmanChannel).publish(n,function(){u.info({event:"accept-agent-message-sent",chatId:e})})},a.prototype.disconnect=function(){this.radar.dealloc("chat")},o.mixin(a),e.exports=a}}}),chatLotus.module(1,function(){return{id:"chat/shared",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){e.exports={service:null,Agent:{maximum_chat_requests:99,chat_welcome_message:""},isAgent:!0,accountName:null}}}}),chatLotus.module(1,function(){return{id:"controllers/chat_controller",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("zendesk"),a=i("../chat"),f=function(e){var t=o.get(e,"id"),n=o.get(e,"newTicketId");return"#/tickets/"+(t||"new/%@".fmt(n))+"/chat"},l=o.Object.extend({workspace:null,ticket:function(){return this.get("workspace.ticket")}.property("workspace.ticket").cacheable(),isNewTicket:function(){return this.get("ticket.isNew")}.property("ticket.isNew").cacheable(),chat:function(){return this.get("ticket.chat")}.property("ticket.chat").cacheable(),canBeActive:function(){return!!this.get("hasChat")}.property("hasChat").cacheable(),isActive:!1,chatHref:function(){return this.get("ticket")?f(this.get("ticket")):""}.property("ticket").cacheable(),activate:function(){this.get("canBeActive")?(this.set("isActive",!0),this.didActivate()):_.delay(function(){u.Routes.goToHash(this.get("workspace.baseHref"))}.bind(this),10)},deactivate:function(){this.set("isActive",!1),this.didDeactivate()},didActivate:function(){var e=this.get("chat");if(!e)return;e.set("workspace",this.get("workspace")),e.set("chatController",this),a.chatsController.set("current",e)},didDeactivate:function(){a.chatsController.set("current",null)},sendMessage:function(){a.chatsController.send(this.get("chat"))},pillVisible:function(){return this.get("canBeActive")}.property("canBeActive").cacheable(),unreadMessages:function(){return this.get("chat.unreadMessages")||0}.property("chat.unreadMessages").cacheable(),hasChat:function(){var e=this.get("chat");return e&&(!e.get("ended")||!e.get("endedByAgent"))}.property("chat","chat.ended","chat.endedByAgent").cacheable(),notHaveChat:o.computed.not("hasChat"),shouldShowEndChat:function(){var e=this.get("workspace.currentMainSection.name"),t=this.get("hasChat");return!(!t||e!=="ticket"&&e!=="chat")}.property("workspace.currentMainSection.name","hasChat").cacheable(),tearDown:function(){var e=this.get("hasChat"),t=this.get("chat");t&&e&&!t.get("ticket.isSaving")&&this.endChat()},endChat:function(){var e=this.get("chat");
e.set("endedByAgent",!0),e.get("ended")?this.routeEndedChat():e.end()},routeEndedChat:function(){var e=this.get("chat");if(!e||!e.get("ticket.id"))return;e.get("newChat")?this._routeEndedChatForNewTicket():this._routeEndedChatForExistingTicket()},_routeEndedChatForNewTicket:function(){var e=this.get("chat"),t=e.get("ticket.id");if(t==null)return;o.run.next(this,function(){var e=u.Ticket.create({id:t}),n=this.get("ticket.comment");this.set("ticket.chat",null);var r=this.get("workspace");r&&r.replaceTicket(e),this.set("ticket.comment",n)})},_routeEndedChatForExistingTicket:function(){o.run.next(this,function(){var e=this.get("workspace");e&&e.fetchData("ticket"),u.Routes.goToHash(this.get("ticket.href")),this.set("ticket.chat",null)})}}).reopenClass({openTicketForChat:function(e){var t;this.isTicketOpenForChat(e)||(t=this.makeTicketForChat(e)),t=t||e.get("ticket");var n=f(t);u.Routes.goToHash(n)},makeTicketForChat:function(e){var t,n;return e.get("ticket.id")?(n=e.get("ticket"),t=n.get("forEditing")):(n=u.Ticket.newTicket(),t=n.get("forEditing"),t.set("newTicketId",n.get("newTicketId")),t.set("assignee",u.User.create({id:u.get("currentUser.id")})),t.set("requester",u.User.create({id:e.get("requester.id")}))),t.set("chat",e),n},isTicketOpenForChat:function(e){return!!e.get("workspace")}});e.exports=l}}}),chatLotus.module(1,function(){return{id:"index",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function c(e){var t=i("zendesk"),n=i("pubsub"),r=i("./shared"),s=i("./lib/service"),u=null;e.Chat=Em.Object.create({isOnline:!1}),e.ChatLotus={NewSubjectView:i("./views/tickets/new_subject_view"),HelperView:i("./views/tickets/helper"),ActivityView:i("./views/activity_view"),ChatView:i("./views/chat_view"),ElapsedTimeView:i("./views/elapsed_time_view"),EndChatButton:i("./views/end_chat_button"),DialerView:i("./views/dialer_view"),SendMessageView:i("./views/send_message_view"),MessageView:i("./views/message_view"),DialerSummaryView:i("./views/dialer_summary_view"),InviteView:i("./views/invite_view"),InvitesCollectionView:i("./views/invites_collection_view"),PreserveContextView:i("./views/preserve_context_view"),ChatController:i("./controllers/chat_controller"),Service:s},t.TicketSharedProperties.reopen({chatHref:function(){return this.get("href")+"/chat"}.property("href").cacheable()}),o.info({event:"initialize-agent-chat"}),n.initialize(function(n,f){var c;if(n!="radar"){o.info("Pubsub is not enabled, but initialize views anyway",n),i("./chat").initialize(e,f,!0);return}c=i("./chat"),c.initialize(e,f,!0),r.Conversation=c.Agent.Model.Conversation,r.User=c.Common.Model.User,window.ChatService=u=c.getService();if(l)return;l=!0,o.debug("Attaching listeners"),c.chatsController.addArrayObserver(i("./lib/workspace_observer")),c.invitesController.addObserver("hasInvites",null,function(){c.invitesController.get("hasInvites")&&a.set("dialerVisible",!0)}),u.on("invite",function(e){o.info("Got new invite to room#"+e.room+" from user#",e.user_id);if(!s.Availability.get("available")){o.info({event:"ignore-invite",message:e,reason:"Agent is not available"});return}c.invitesController.add({chatId:e.room,userId:e.user_id,id:e.respond_with,subject:e.subject,params:e.params}).done(function(){c.invitesController.get("hasInvites")&&a.set("dialerVisible",!0)})}),u.on("accept",function(n){var i=r.pendingInvites[n.room];if(!i||i=="ignore"){o.info({event:"reject-invite",message:n}),c.invitesController.remove(n.room);return}o.info({event:"accept-invite",chatId:n.room});var s=c.chatsController.add(n.room),u=c.invitesController.remove(n.room);u&&(s.set("requester",u.get("user")),s.set("ticketId",u.get("params.ticket_id")),s.publishUserInfo(t.currentUser,u.userId)),e.ChatLotus.ChatController.openTicketForChat(s)}),u.on("cancel",function(e){o.info({event:"cancel-invite",chatId:e.room}),c.invitesController.remove(e.room)})})}i("./casperjs-patch");var o=i("minilog")("chat_lotus_init"),u=i("lib/current_account"),a=i("lib/voice/state").instance(),f=e.exports={globals:c(window)},l=!1}}}),chatLotus.module(1,function(){return{id:"lib/service",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){function l(){c.Availability.get("available")?ChatService.status.available():ChatService.status.unavailable()}var o=i("ember"),u=i("pubsub"),a=i("../shared"),f=i("lib/computed").oneWay,c=e.exports=o.Namespace.extend({globalPermissions:Zd.get("globalPermissions"),hasChatEnabled:f("globalPermissions.chatEnabled"),Availability:o.Object.extend({available:!1,toggleAvailability:function(){this.get("available")?this.setUnavailable():this.setAvailable()},dialerAvailability:function(){return this.get("available")?I18n.t("txt.voice.dialer.online"):I18n.t("txt.voice.dialer.offline")}.property("available").volatile(),availabilityClass:function(){return this.get("available")?"available":"unavailable"}.property("available").volatile(),setAvailable:function(){this.set("available",!0),u.connected(l)},setUnavailable:function(){this.set("available",!1),l()}}).create(),Invitations:o.Object.extend({ignore:function(e){this.trigger("ignore",e.context)},accept:function(e){this.trigger("accept",e.context)},trigger:function(e,t){var n=o.get("Chat.invitesController");a.pendingInvites[t.chatId]=e,n[e](t)}}).create()}).create()}}}),chatLotus.module(1,function(){return{id:"lib/workspace_observer",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("zendesk"),a=i("../chat").Common.Observer,f=i("./../controllers/chat_controller"),l=i("lib/voice/state").instance(),c=e.exports=a.create({itemWasAdded:function(e){l.set("dialerVisible",!1)}})}}}),chatLotus.module(1,function(){return{id:"shared",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){e.exports={pendingInvites:{},User:null,Conversation:null}}}}),chatLotus.module(1,function(){return{id:"views/activity_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("./message_view"),u=i("./chat_view"),a=e.exports=o.extend({templateName:"chat/activity",content:null,enduserStateBinding:Em.Binding.oneWay("content.participants.enduser.state"),didInsertElement:function(){this._super();var e=this.nearestInstanceOf(u);e&&e.observeFocus(this,"_scrollDown",!0)},activity:function(e){var t=this.get("enduserState"),n=this.get("content");return t&&{user:n&&n.participants.getById(t.userId),active:t.value==1,typing:t.value==2,paused:t.value==3,stopped:t.value==4,gone:t.value==5}}.property("enduserState"),onActivityChanged:function(){var e=this.get("enduserState");e&&(e.value==2||e.value==1)&&Em.run.next(this,this._scrollDown)}.observes("enduserState")}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/chat_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("lotus"),a=o.Object.extend(Ember.TargetActionSupport,{visible:o.required(),triggerAction:function(e){this.get("visible")==e&&this._super()}}),f=o.Mixin.create({targetActions:[],observeFocus:function(e,t,n){this.get("targetActions").push(a.create({target:e,action:t,visible:!!n}))},_watchIsVisible:function(){var e=this.get("isVisible");o.run.next(this,function(){this.get("targetActions").forEach(function(t){t.triggerAction(e)})})}.observes("isVisible")}),l=o.View.extend(f,{templateName:"chat/frame",classNames:["chat"],resetScroll:function(){this.get("isVisible")&&o.run.next(this,function(){var e=this.$(".chat_body");e.animate({scrollTop:e.prop("scrollHeight")},-1)})}.observes("isVisible")}).reopenClass({preservesContext:!0});e.exports=l}}}),chatLotus.module(1,function(){return{id:"views/dialer_summary_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=e.exports=Em.View.extend({classNames:["below","chat_summary"],isVisibleBinding:Em.Binding.oneWay("Chat.invitesController.hasInvites")}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/dialer_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=e.exports=Em.View.extend({templateName:"chat/dialer",invitesBinding:"Chat.invitesController",isVisibleBinding:"ChatLotus.Service.hasChatEnabled",displaySummary:!1,toggleSummary:function(){this.set("displaySummary",!this.get("displaySummary"))}}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/elapsed_time_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=e.exports=o.View.extend({template:o.Handlebars.compile("{{view.duration}}"),content:null,duration:function(e){var t=this.get("content");if(typeof t=="undefined")return"--";var n="",r=Math.floor(t/3600),i=Math.floor(t/60)%60,s=t%60;return r&&(n+=I18n.t("txt.chat.user_wait_hours",{hours:r})+" "),i&&(n+=I18n.t("txt.chat.user_wait_minutes",{minutes:i})+" "),s&&(n+=I18n.t("txt.chat.user_wait_seconds",{seconds:s})),n}.property("content")}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/end_chat_button",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=e.exports=o.View.extend({templateName:"chat/end_chat_button",isVisibleBinding:o.Binding.oneWay("workspace.chatController.shouldShowEndChat"),endChat:function(){this.get("workspace.chatController").endChat()}}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/invite_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=e.exports=Em.View.extend({classNames:["invite"],didInsertElement:function(){var e=this;this.$().mouseenter(function(){e.$(".buttons").slideDown(100)}).mouseleave(function(){e.$(".buttons").slideUp(100)})}}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/invites_collection_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=e.exports=Em.CollectionView.extend({classNames:["invites"]}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/message_body",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=o.View,a=o.Handlebars;e.exports=u.extend({template:a.compile("{{renderMessage content}}"),content:null}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/message_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("underscore"),a=e.exports=o.View.extend({templateName:"chat/message",notification:function(){var e=this.content.get("user").get("name"),t=this.content.get("user").get("alias"),n=this.content.get("userJoined");return o.I18n.t("txt.chat.user_"+(n?"joined":"left"),{user:t||e})}.property("content.user.name","content.user.alias"),didInsertElement:function(){this._super(),this._scrollDown()},_scrollDown:function(){var e=this.nearestWithProperty("scrollContainer");if(!e)return;var t=e.$(),n=t.prop("scrollHeight");t.stop().animate({scrollTop:n},500)}}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/preserve_context_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=e.exports=o.View.extend().reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/send_message",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("jquery"),u=i("ember");e.exports=u.TextArea.extend({keyDown:function(){function n(){var n=e.val();n!=t&&(t=n),n.length===0&&window.Chat.activitySender.notifyDelete()}var e,t;return function(t){e||(e=o(this.get("element")),e.keydown(n),e.keyup(n),e.click(n)),t.keyCode==13&&(window.Chat.chatsController.send(this.get("chat")),t.preventDefault()),window.Chat.activitySender.notifyTyping()}}()}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/send_message_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=i("ember"),u=i("./send_message.js"),a=e.exports=u.extend({didInsertElement:function(){this._super();var e=this.nearestInstanceOf(ChatLotus.ChatView);e.observeFocus(this,"focus",!0),this.focus()},focus:function(){o.run.next(this,function(){this.$(this.get("element")).focus()})}}).reopenClass({preservesContext:!0})}}}),chatLotus.module(1,function(){return{id:"views/tickets/helper",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){(function(){Handlebars.registerHelper("chatTicketHref",function(){var e=this.get("content.ticketId"),t=this.get("content.ticketLink");return new Handlebars.SafeString('<a href="#/tickets/%@">%@</a>'.fmt(e,t))}),Handlebars.registerHelper("chatOrganizationHref",function(){var e=this.get("content.userId");return new Handlebars.SafeString("#/users/%@/organization/tickets".fmt(e))}),Handlebars.registerHelper("chatUserHref",function(){var e=this.get("content.userId");return new Handlebars.SafeString("#/users/%@".fmt(e))})})()}}}),chatLotus.module(1,function(){return{id:"views/tickets/new_subject_view",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){(function(){Em.View.extend(i("lib/lotus/labeled_text_field"),{isVisibleBinding:Em.Binding.oneWay("workspace.chatController.notHaveChat")})})()}}}),chatLotus.pkg(1,function(e){return{id:2,name:"miniee",main:undefined,mainModuleId:"miniee",modules:[],parents:e}}),chatLotus.module(2,function(){return{id:"miniee",pkg:arguments[0],wrapper:function(e,t,n,r,i,s){var o=function(){};o.prototype.each=function(e,t,n){var r={};if(e==null)return;if(Array.prototype.forEach&&e.forEach===Array.prototype.forEach)e.forEach(t,n);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(n,e[i],i,e)===r)return}else for(var o in e)if(e.hasOwnProperty(o)&&t.call(n,e[o],o,e)===r)return},o.prototype.filter=function(e,t,n){var r=[];return e==null?r:Array.prototype.filter&&e.filter===Array.prototype.filter?e.filter(t,n):(o.prototype.each(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},o.prototype.on=function(e,t){return e instanceof RegExp?(this._routes||(this._routes=[]),this._routes.unshift([e,t])):(this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].unshift(t)),this},o.prototype.addListener=o.prototype.on,o.prototype.once=function(e,t){function r(){n.removeListener(e,r),t.apply(this,arguments)}var n=this;return r.listener=t,n.on(e,r),this},o.prototype.when=function(e,t){function r(){t.apply(this,arguments)&&n.removeListener(e,r)}var n=this;return r.listener=t,n.on(e,r),this},o.prototype.removeListener=function(e,t){return e instanceof RegExp&&this._routes?this._routes=o.prototype.filter(this._routes,function(n){return n[0].toString()!=e.toString()||!(n[1]===t||n[1].listener&&n[1].listener===t)}):this._events&&this._events[e]&&(this._events[e]=o.prototype.filter(this._events[e],function(e){return!(e===t||e.listener&&e.listener===t)})),this},o.prototype.removeAllListeners=function(e){if(arguments.length===0){this._events={},this._routes=[];return}return e instanceof RegExp&&this._routes?this._routes=o.prototype.filter(this._routes,function(t){return t[0].toString()!=e.toString()}):this._events&&this._events[e]&&(this._events[e]=[]),this},o.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments,1),n;if(this._events&&this._events[e])for(n=this._events[e].length-1;n>-1&&this._events[e]&&this._events[e][n];n--)this._events[e][n].apply(this,t);if(this._routes)for(n=this._routes.length-1;n>-1;n--)this._routes[n][0].test(e)&&this._routes[n][1].apply(this,t);return this},o.mixin=function(e){var t=["on","removeListener","removeAllListeners","emit","next","once","when"];for(var n=0;n<t.length;n++)e.prototype[t[n]]=o.prototype[t[n]]},typeof e!="undefined"&&(e.exports=o)}}}),typeof module!="undefined"&&module.exports&&(module.exports=chatLotus,module.parent||chatLotus.main()),chatLotus.main();